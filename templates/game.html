<body>
    <h1>Adivina la canción</h1>
    <div>
        <img id="thumb" src="" alt="Pista Visual" style="max-width: 300px; display: none;">
    </div>
    <button onclick="playSnippet()">Reproducir fragmento</button>
    <input id="guess" type="text" placeholder="Tu respuesta" oninput="autocompleteGuess()">
    <ul id="autocomplete-results"></ul>
    <button onclick="submitGuess()">Enviar</button>
</body>

<script>
    let songData = {};
    let gameMode = "{{ mode }}";
    let attemptsLeft = 6;

    function fetchSongData() {
        fetch(`/api/song/${gameMode}`)
            .then(res => res.json())
            .then(data => {
                songData = data;
                if (data.thumbUrl) {
                    document.getElementById("thumb").src = data.thumbUrl;
                    document.getElementById("thumb").style.display = "block";
                }
            });
    }

    function playSnippet() {
        const audio = new Audio(songData.snippetUrl);
        if (songData.snippetUrl) {
            audio.play().catch(error => {
                console.error("Error al reproducir el fragmento: ", error);
            });
        } else {
            alert("No se encontró un fragmento para esta canción.");
        }
        //const audio = new Audio(songData.snippetUrl);
        const snippetDurations = [1, 2, 3, 4, 5, 6];
        audio.currentTime = 0;
        audio.play();
        setTimeout(() => audio.pause(), snippetDurations[6 - attemptsLeft] * 1000);
    }

    function submitGuess() {
        const guess = document.getElementById("guess").value;

        fetch("/guess", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                answer: guess,
                mode: gameMode,
                ...songData
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.correct) {
                alert("¡Correcto!");
            } else {
                attemptsLeft--;
                if (attemptsLeft > 0) {
                    alert(`Incorrecto, te quedan ${attemptsLeft} intentos.`);
                } else {
                    alert("No te quedan más intentos.");
                }
            }
        });
    }

    function autocompleteGuess() {
        const query = document.getElementById("guess").value;
        if (query.length > 1) {
            fetch(`/autocomplete?q=${query}`)
                .then(res => res.json())
                .then(songs => {
                    const autocompleteResults = document.getElementById("autocomplete-results");
                    autocompleteResults.innerHTML = "";
                    songs.forEach(song => {
                        const li = document.createElement("li");
                        li.textContent = song;
                        li.onclick = () => {
                            document.getElementById("guess").value = song;
                            autocompleteResults.innerHTML = "";
                        };
                        autocompleteResults.appendChild(li);
                    });
                });
        }
    }

    fetchSongData();
</script>
